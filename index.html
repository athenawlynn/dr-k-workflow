
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Dr. K Workflow v2.4</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useRef } = React;

const PasswordGate = ({ children }) => {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [isChecking, setIsChecking] = useState(true);
  const CORRECT_PASSWORD = 'jekoch78';
  const AUTH_KEY = 'drk-workflow-auth';
  useEffect(() => {
    const authData = localStorage.getItem(AUTH_KEY);
    if (authData) {
      try { const { remembered } = JSON.parse(authData); if (remembered) setIsAuthenticated(true); } catch (e) { localStorage.removeItem(AUTH_KEY); }
    }
    setIsChecking(false);
  }, []);
  const handleSubmit = (e) => {
    e.preventDefault();
    if (password === CORRECT_PASSWORD) { localStorage.setItem(AUTH_KEY, JSON.stringify({ remembered: true, device: navigator.userAgent })); setIsAuthenticated(true); setError(''); }
    else { setError('Incorrect password'); setPassword(''); }
  };
  const handleLogout = () => { localStorage.removeItem(AUTH_KEY); setIsAuthenticated(false); setPassword(''); };
  if (isChecking) return <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center"><div className="text-white text-xl">Loading...</div></div>;
  if (!isAuthenticated) return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <div className="text-center mb-8"><h1 className="text-3xl font-serif font-bold text-indigo-900 mb-2">Dr. K Workflow</h1><p className="text-gray-600">Please enter password to continue</p></div>
        <form onSubmit={handleSubmit} className="space-y-4">
          <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Enter password" className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:outline-none" autoFocus />
          {error && <p className="text-red-600 text-sm text-center">{error}</p>}
          <button type="submit" className="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold text-lg">ğŸ” Access Workflow</button>
        </form>
      </div>
    </div>
  );
  return children(handleLogout);
};

const DailyTaskTracker = ({ onLogout }) => {
  const [tasks, setTasks] = useState([]);
  const [currentFilter, setCurrentFilter] = useState('all');
  const [activeSection, setActiveSection] = useState('tasks');
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [saveError, setSaveError] = useState(null);
  const [lastSaveTime, setLastSaveTime] = useState(null);
  const [editingTaskId, setEditingTaskId] = useState(null);
  const [recapText, setRecapText] = useState('');
  const [calendarYear, setCalendarYear] = useState(2026);
  const tasksRef = useRef(tasks);
  useEffect(() => { tasksRef.current = tasks; }, [tasks]);

  // New Hires state
  const [newHires, setNewHires] = useState([]);
  const [newHireForm, setNewHireForm] = useState({ name: '', position: '', startDate: '', department: '', phone: '', email: '', notes: '', photo: '' });
  const [editingNewHireId, setEditingNewHireId] = useState(null);

  const saveNewHiresToStorage = async (hiresToSave) => {
    try { localStorage.setItem('newhires-backup', JSON.stringify(hiresToSave)); } catch(e) {}
    try { await fetch(SHEETS_API_URL, { method: 'POST', redirect: 'follow', body: JSON.stringify({ type: 'newhires', newhires: hiresToSave }) }); } catch(e) { console.error('New hires save error:', e); }
  };

  const loadNewHiresFromStorage = () => {
    const backup = localStorage.getItem('newhires-backup');
    if (backup) { try { const parsed = JSON.parse(backup); if (Array.isArray(parsed)) setNewHires(parsed); } catch(e) {} }
  };

  useEffect(() => { loadNewHiresFromStorage(); }, []);

  const handleNewHirePhoto = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => setNewHireForm(prev => ({ ...prev, photo: ev.target.result }));
    reader.readAsDataURL(file);
  };

  const addNewHire = async () => {
    if (!newHireForm.name.trim()) { alert('Please enter the employee name'); return; }
    const newHire = { id: Date.now(), ...newHireForm };
    const updated = [newHire, ...newHires];
    setNewHires(updated);
    setNewHireForm({ name: '', position: '', startDate: '', department: '', phone: '', email: '', notes: '', photo: '' });
    await saveNewHiresToStorage(updated);
  };

  const deleteNewHire = async (id) => {
    if (window.confirm('Remove this new hire record?')) {
      const updated = newHires.filter(h => h.id !== id);
      setNewHires(updated);
      await saveNewHiresToStorage(updated);
    }
  };

  const startEditNewHire = (hire) => {
    setEditingNewHireId(hire.id);
    setNewHireForm({ name: hire.name || '', position: hire.position || '', startDate: hire.startDate || '', department: hire.department || '', phone: hire.phone || '', email: hire.email || '', notes: hire.notes || '', photo: hire.photo || '' });
  };

  const saveEditNewHire = async () => {
    if (!newHireForm.name.trim()) { alert('Please enter the employee name'); return; }
    const updated = newHires.map(h => h.id === editingNewHireId ? { ...h, ...newHireForm } : h);
    setNewHires(updated);
    setEditingNewHireId(null);
    setNewHireForm({ name: '', position: '', startDate: '', department: '', phone: '', email: '', notes: '', photo: '' });
    await saveNewHiresToStorage(updated);
  };

  const cancelEditNewHire = () => {
    setEditingNewHireId(null);
    setNewHireForm({ name: '', position: '', startDate: '', department: '', phone: '', email: '', notes: '', photo: '' });
  };

  const [travelEntries, setTravelEntries] = useState([
    { id: 1, type: "Flight", description: "ATL to Memphis - Flight DL1700 Departs at 4:15 PM", startDate: "2026-02-26", endDate: "2026-02-26", location: "Memphis", confirmation: "#GX5JAV", url: "", tags: ["Flight"] },
    { id: 2, type: "Hotel", description: "Hilton Memphis Hotel", startDate: "2026-02-26", endDate: "2026-02-28", location: "Memphis", confirmation: "3395896664", url: "", tags: ["Hotel"] },
    { id: 3, type: "Course", description: "The Lifestyle Formula In-Person Course with Dr. Kyle Fagala", startDate: "2026-02-26", endDate: "2026-02-28", location: "Memphis", confirmation: "#135768106673", url: "", tags: ["Course", "Event"] },
    { id: 4, type: "Flight", description: "Memphis to ATL - Flight DL1693 Departs at 4:30", startDate: "2026-02-28", endDate: "2026-02-28", location: "Atlanta, GA", confirmation: "#GX5JAV", url: "", tags: ["Flight"] },
    { id: 5, type: "Flight", description: "ATL to Phoenix", startDate: "2026-04-17", endDate: "2026-04-17", location: "TBD", confirmation: "TBD", url: "", tags: ["Flight"] },
    { id: 6, type: "Event", description: "Nicole McFarlane - Office Manager Workshop", startDate: "2026-04-17", endDate: "2026-04-18", location: "Phoenix", confirmation: "TBD", url: "", tags: ["Event", "Conference"] },
    { id: 7, type: "Hotel", description: "Phoenix Hotel", startDate: "2026-04-17", endDate: "2026-04-18", location: "Phoenix", confirmation: "TBD", url: "", tags: ["Hotel"] },
    { id: 8, type: "Flight", description: "Phoenix to ATL", startDate: "2026-04-18", endDate: "2026-04-18", location: "TBD", confirmation: "TBD", url: "", tags: ["Flight"] },
    { id: 9, type: "Event", description: "Transforming Lives with The Pitts21 Platform", startDate: "2026-06-05", endDate: "2026-06-06", location: "Atlanta, GA", confirmation: "", url: "", tags: ["Event"] },
    { id: 10, type: "Event", description: "Koch Family Reunion â€“ Yellowstone 2026", startDate: "2026-06-20", endDate: "2026-06-27", location: "Yellowstone", confirmation: "TBD", url: "", tags: ["Event"] },
    { id: 11, type: "Flight", description: "Return to ATL from Yellowstone", startDate: "2026-06-27", endDate: "2026-06-27", location: "TBD", confirmation: "TBD", url: "", tags: ["Flight"] }
  ]);
  const [travelForm, setTravelForm] = useState({ type: 'Flight', description: '', startDate: '', endDate: '', location: '', confirmation: '', url: '', tags: [] });
  const [editingTravelId, setEditingTravelId] = useState(null);
  const [travelSearchQuery, setTravelSearchQuery] = useState('');
  const [travelTagFilter, setTravelTagFilter] = useState('all');
  const travelTags = ['Flight', 'Hotel', 'Car', 'Event', 'Conference', 'Course'];

  const [contacts, setContacts] = useState([
    { id: 1, category: 'Handyman', name: 'Leo', phone: '(404) 801-8245', email: '', website: '', notes: 'Remax' },
    { id: 2, category: 'Handyman', name: 'Fitzroy - ZNS Handyman', phone: '(470) 289-0327', email: '', website: 'https://www.znshandyman.com/', notes: '' },
    { id: 3, category: 'Personal Coach', name: 'Julie Nise', phone: '(850) 502-5519 / (540) 520-2055', email: 'J.nise@att.net', website: 'http://tkvw.com/julienise/success_mentoring.html', notes: '' },
    { id: 4, category: 'Nutrition', name: 'Project Lean - Laura', phone: '(470) 398-4403 / (470) 792-8360', email: 'plnlawrenceville@projectleannation.com', website: 'https://projectleannation.com/locations/lawrenceville-ga', notes: '' },
    { id: 5, category: 'Medical', name: 'Dr. Yong Shik Kim, MD', phone: '404-727-8820', email: '', website: 'https://mychart.emoryhealthcare.org', notes: 'Emory Healthcare' },
    { id: 6, category: 'Medical', name: 'Gwinnett Sleep', phone: '678-942-5982', email: '', website: '', notes: 'Office' },
    { id: 7, category: 'Architect', name: 'Scott Zanardo', phone: '770.806.1031', email: 'szanardo@zanardopc.com', website: 'https://www.zanardopc.com/', notes: '' },
    { id: 8, category: 'Financial', name: 'Doug Bochat - Fractional CFO', phone: '678-576-5670', email: 'doug.bochat@roundtable-advisors.com', website: '', notes: 'Roundtable Advisors' },
    { id: 9, category: 'Legal', name: 'Austin Buerlein - Family Law', phone: '404-759-9537 / Office: 404-662-2266', email: 'Austin@fbfamilylawfirm.com', website: 'www.fbfamilylawfirm.com', notes: 'Karina Nunez at 404-662-2266' },
    { id: 10, category: 'Legal', name: 'W. Jonathan Martin - Employment', phone: '478.621.2407', email: 'jmartin@constangy.com', website: '', notes: 'Employment Attorney' },
    { id: 11, category: 'Auto', name: 'Tesla Service - Julia/Brianna', phone: '(770) 810-1743 / 888-518-3752', email: '', website: '', notes: 'RN122960924, VIN 7SAXCBE66RF455791, Loan 12429213035204, Finance: 1-800-336-6675' },
    { id: 12, category: 'Auto', name: 'Alloy Wheel Repair', phone: '(404) 296-4827', email: '', website: 'https://www.awrswheelrepair.com/', notes: '3100 Medlock Bridge Rd #320, Norcross. Last car at 4:30' },
    { id: 13, category: 'Home', name: 'Bryan Duckworth - Impact Fitness', phone: '(770) 757-5250', email: '', website: '', notes: 'Exercise Equipment Installer' },
    { id: 14, category: 'Home', name: 'Best Buy - Chion', phone: '(770) 713-9614', email: '', website: '', notes: '' },
    { id: 15, category: 'Home', name: 'Consolidated Electronics', phone: '(770) 455-0158', email: '', website: 'https://cecardio.com/about-us', notes: '' },
    { id: 16, category: 'Home', name: 'Dvault - Cc Boshof', phone: '770-831-2322 opt 3 / 719-955-2698', email: 'sales@dvault.com', website: '', notes: 'Tracking 6456617403' },
    { id: 17, category: 'Home', name: 'Hanco Pest Control - Joseph', phone: '(678) 409-3689', email: '', website: 'https://www.hancoexterminating.com/', notes: '' },
    { id: 18, category: 'Home', name: 'Simply Septic - Jimmy', phone: '(678) 755-6387', email: 'simpleseptic@gmail.com', website: 'https://www.simplysepticservice.com/', notes: 'Will call 30 min in advance' },
    { id: 19, category: 'Cleaning', name: 'Chris the Cleaner', phone: '', email: '', website: '', notes: '1030 Old Peachtree Rd NW' },
    { id: 20, category: 'Cleaning', name: 'Reliable Cleaning - Manuela', phone: '(507) 629-2612', email: '', website: 'https://clienthub.getjobber.com/client_hubs/2422aa94-8b6f-4660-9b4f-1b66b680c9df/quotes', notes: 'Ingri & Jorge' },
    { id: 21, category: 'Cleaning', name: "Heaven's Best Carpet", phone: '678-822-1558', email: '', website: 'https://lawrencevillega.hbcarpetcleaning.com/', notes: '' },
    { id: 22, category: 'HVAC', name: 'Mike Massey', phone: '(770) 843-6375', email: '', website: '', notes: 'Good for emergencies' },
    { id: 23, category: 'HVAC', name: 'Triad Mechanical', phone: '', email: '', website: '', notes: '' },
    { id: 24, category: 'IT/Networking', name: 'Teamspring - James Sandford', phone: '(678) 333-1655 / Office: 770-614-9495', email: '', website: '', notes: 'Local IT Networking' },
    { id: 25, category: 'IT/Networking', name: 'Teamspring - Charlene Riggs', phone: '770-614-9495', email: '', website: '', notes: '' },
    { id: 26, category: 'IT/Networking', name: 'MME IT - Dan Harris', phone: '916-550-5527', email: '', website: '', notes: 'Remote Networking' },
    { id: 27, category: 'Coaching', name: 'Mary Gladu - Accent Coach', phone: '', email: 'acmaryel@gmail.com', website: 'https://www.maryelaccentcoach.com/', notes: 'Login: email / g*^EiP9p%j' },
    { id: 28, category: 'Coaching', name: 'Melissa - Tony Robbins', phone: '(858) 401-6377', email: '', website: '', notes: '' },
    { id: 29, category: 'Tasker', name: 'Jaycob', phone: '(470) 696-4597', email: '', website: '', notes: '' },
    { id: 30, category: 'Dental', name: 'Atlanta Dental - Brian Stallings', phone: '770-851-8575', email: '', website: '', notes: '' },
    { id: 31, category: 'Dental', name: 'Lund Orthodontics - Misty Wales', phone: '425-418-9869', email: '', website: '', notes: '' },
    { id: 32, category: 'Breeder', name: 'Mackenzie Terrebonne - Kitten', phone: '470-219-8002', email: '', website: '', notes: '' },
    { id: 33, category: 'Chef', name: 'Kay Dickey', phone: '470-322-0609', email: '', website: 'https://cash.app/$bakekay', notes: 'Cash App' },
    { id: 34, category: 'Therapist', name: 'Joyce Moore, MEd, NCC, LPC', phone: '(404) 983-2060', email: '', website: '', notes: '$100/session, Aetna, 800 Lawrenceville Hwy. Anxiety, Depression, Grief. CBT/humanistic.' },
    { id: 35, category: 'Events', name: 'Krewe of Bacchus', phone: '', email: '', website: 'https://bacchus.krewesctrl.com/', notes: '' }
  ]);
  const [contactSearch, setContactSearch] = useState('');
  const [contactCategoryFilter, setContactCategoryFilter] = useState('all');
  const [contactForm, setContactForm] = useState({ category: 'Handyman', name: '', phone: '', email: '', website: '', notes: '' });
  const [editingContactId, setEditingContactId] = useState(null);
  const contactCategories = ['Architect', 'Auto', 'Breeder', 'Chef', 'Cleaning', 'Coaching', 'Dental', 'Events', 'Financial', 'Handyman', 'Home', 'HVAC', 'IT/Networking', 'Legal', 'Medical', 'Nutrition', 'Personal Coach', 'Tasker', 'Therapist', 'Other'];

  const getFilteredContacts = () => {
    let filtered = contacts;
    if (contactCategoryFilter !== 'all') filtered = filtered.filter(c => c.category === contactCategoryFilter);
    if (contactSearch.trim()) {
      const q = contactSearch.toLowerCase();
      filtered = filtered.filter(c => c.name.toLowerCase().includes(q) || c.category.toLowerCase().includes(q) || (c.notes || '').toLowerCase().includes(q) || (c.phone || '').includes(q));
    }
    return filtered.sort((a, b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name));
  };

  const SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbwwQdAcaQbcvG4rBOwF7Adr0JM7Y1DtsruQmWS9Xlwi8TwcM725BUgPDY57m86SwIOhFA/exec';

  const saveContactsToStorage = async (contactsToSave) => {
    try { localStorage.setItem('contacts-backup', JSON.stringify(contactsToSave)); } catch(e) {}
    try { await fetch(SHEETS_API_URL, { method: 'POST', redirect: 'follow', body: JSON.stringify({ type: 'contacts', contacts: contactsToSave }) }); } catch(e) { console.error('Contacts save error:', e); }
  };

  const loadContactsFromStorage = async () => {
    try {
      const response = await fetch(SHEETS_API_URL + '?action=getContacts');
      const text = await response.text();
      let data;
      try { data = JSON.parse(text); } catch(e) { throw new Error('Invalid response'); }
      if (data.success && data.contacts && Array.isArray(data.contacts) && data.contacts.length > 0) {
        setContacts(data.contacts);
        try { localStorage.setItem('contacts-backup', JSON.stringify(data.contacts)); } catch(e) {}
      }
    } catch(e) {
      console.error('Contacts load error:', e);
      const backup = localStorage.getItem('contacts-backup');
      if (backup) { try { const parsed = JSON.parse(backup); if (Array.isArray(parsed) && parsed.length > 0) setContacts(parsed); } catch(e) {} }
    }
  };

  const addContact = async () => {
    if (!contactForm.name.trim()) { alert('Please enter a contact name'); return; }
    const newContact = { id: Date.now(), ...contactForm };
    const updated = [newContact, ...contacts];
    setContacts(updated);
    setContactForm({ category: 'Handyman', name: '', phone: '', email: '', website: '', notes: '' });
    await saveContactsToStorage(updated);
  };

  const deleteContact = async (id) => {
    if (window.confirm('Delete this contact?')) { const updated = contacts.filter(c => c.id !== id); setContacts(updated); await saveContactsToStorage(updated); }
  };

  const startEditContact = (contact) => {
    setEditingContactId(contact.id);
    setContactForm({ category: contact.category || 'Other', name: contact.name || '', phone: contact.phone || '', email: contact.email || '', website: contact.website || '', notes: contact.notes || '' });
  };

  const saveEditContact = async () => {
    if (!contactForm.name.trim()) { alert('Please enter a contact name'); return; }
    const updated = contacts.map(c => c.id === editingContactId ? { ...c, ...contactForm } : c);
    setContacts(updated);
    setEditingContactId(null);
    setContactForm({ category: 'Handyman', name: '', phone: '', email: '', website: '', notes: '' });
    await saveContactsToStorage(updated);
  };

  const cancelEditContact = () => { setEditingContactId(null); setContactForm({ category: 'Handyman', name: '', phone: '', email: '', website: '', notes: '' }); };

  useEffect(() => { loadContactsFromStorage(); }, []);

  const [darkMode, setDarkMode] = useState(() => {
    const saved = localStorage.getItem('darkMode');
    if (saved !== null) return saved === 'true';
    return window.matchMedia('(prefers-color-scheme: dark)').matches;
  });

  const [formData, setFormData] = useState({ category: 'Review', tag: 'Office', description: '', emailLink: '', urgent: false, attachments: [], comeBackDate: '' });

  useEffect(() => { loadTasksFromStorage(); }, []);

  useEffect(() => {
    const autoSaveInterval = setInterval(() => {
      if (tasksRef.current && tasksRef.current.length > 0) { console.log('Auto-saving tasks...'); saveTasksToStorage(tasksRef.current); }
    }, 5 * 60 * 1000);
    return () => clearInterval(autoSaveInterval);
  }, []);

  const safeString = (val) => {
    if (val === null || val === undefined || val === true || val === false) return '';
    return String(val);
  };

  const normalizeTask = (task) => {
    if (!task) return null;
    return {
      id: task.id || Date.now(),
      category: safeString(task.category) || 'Review',
      tag: safeString(task.tag) || 'Office',
      description: safeString(task.description),
      emailLink: safeString(task.emailLink),
      urgent: Boolean(task.urgent),
      completed: Boolean(task.completed),
      carriedOver: Boolean(task.carriedOver),
      notesDrK: safeString(task.notesDrK) || safeString(task.notes),
      notesAthena: safeString(task.notesAthena),
      attachments: Array.isArray(task.attachments) ? task.attachments : [],
      comeBackDate: safeString(task.comeBackDate).split('T')[0]
    };
  };

  const removeDuplicateTasks = (taskList) => {
    if (!taskList || !Array.isArray(taskList)) return [];
    const seen = new Map();
    return taskList.filter(task => {
      if (!task) return false;
      const desc = safeString(task.description);
      const key = safeString(task.category) + '|' + safeString(task.tag) + '|' + desc.substring(0, 100);
      if (seen.has(key)) return false;
      seen.set(key, true);
      return true;
    });
  };

  const loadTasksFromStorage = async () => {
    setIsLoading(true);
    setSaveError(null);
    try {
      const response = await fetch(SHEETS_API_URL + '?action=getTasks');
      const text = await response.text();
      let data;
      try { data = JSON.parse(text); } catch(e) { throw new Error('Invalid response'); }
      if (data.success && data.tasks && Array.isArray(data.tasks) && data.tasks.length > 0) {
        const normalizedTasks = data.tasks.map(normalizeTask).filter(t => t !== null);
        const uniqueTasks = removeDuplicateTasks(normalizedTasks);
        setTasks(uniqueTasks);
        try { localStorage.setItem('tasks-backup-latest', JSON.stringify(uniqueTasks)); } catch (e) {}
      } else { setTasks([]); }
    } catch (error) {
      console.error('Load error:', error);
      setSaveError('Failed to load. Click Sync.');
      const backup = localStorage.getItem('tasks-backup-latest');
      if (backup) {
        try { const parsed = JSON.parse(backup); setTasks(parsed.map(normalizeTask).filter(t => t !== null)); setSaveError('Loaded from backup. Click Sync to retry.'); } catch(e) { setTasks([]); }
      } else { setTasks([]); }
    } finally { setIsLoading(false); }
  };

  const saveTasksToStorage = async (tasksToSave) => {
    if (!tasksToSave || tasksToSave.length === 0) return { success: false };
    setIsSaving(true);
    setSaveError(null);
    const normalizedTasks = tasksToSave.map(normalizeTask).filter(t => t !== null);
    const cleanedTasks = removeDuplicateTasks(normalizedTasks);
    try { localStorage.setItem('tasks-backup-latest', JSON.stringify(cleanedTasks)); } catch (e) {}
    try {
      await fetch(SHEETS_API_URL, { method: 'POST', redirect: 'follow', body: JSON.stringify(cleanedTasks) });
      setLastSaveTime(new Date().toLocaleTimeString());
      return { success: true };
    } catch (error) {
      setSaveError('Save may have failed. Click Retry.');
      return { success: false };
    } finally { setIsSaving(false); }
  };

  const restoreFromBackup = () => {
    const backup = localStorage.getItem('tasks-backup-latest');
    if (backup) {
      try { const parsed = JSON.parse(backup); const normalized = parsed.map(normalizeTask).filter(t => t !== null); setTasks(normalized); alert('Restored ' + normalized.length + ' tasks from backup'); }
      catch(e) { alert('Backup corrupted'); }
    } else { alert('No backup found'); }
  };

  const addTask = async () => {
    if (!formData.description.trim()) { alert('Please enter a task description'); return; }
    const newTask = normalizeTask({ id: Date.now(), ...formData, completed: false, carriedOver: false });
    const updatedTasks = [newTask, ...tasks];
    setTasks(updatedTasks);
    await saveTasksToStorage(updatedTasks);
    setFormData({ category: 'Review', tag: 'Office', description: '', emailLink: '', urgent: false, attachments: [], comeBackDate: '' });
  };

  const toggleComplete = async (id) => { const updatedTasks = tasks.map(t => t.id === id ? { ...t, completed: !t.completed } : t); setTasks(updatedTasks); await saveTasksToStorage(updatedTasks); };
  const deleteTask = async (id) => { if (window.confirm('Delete this task?')) { const updatedTasks = tasks.filter(t => t.id !== id); setTasks(updatedTasks); await saveTasksToStorage(updatedTasks); } };

  const [editingNotes, setEditingNotes] = useState({});
  const updateLocalNote = (id, noteType, value) => { setEditingNotes(prev => ({ ...prev, [id]: { ...prev[id], [noteType]: value } })); };
  const saveNoteOnBlur = async (id, noteType) => {
    const noteValue = editingNotes[id]?.[noteType];
    if (noteValue === undefined) return;
    const updatedTasks = tasks.map(t => t.id === id ? { ...t, [noteType]: noteValue } : t);
    setTasks(updatedTasks);
    await saveTasksToStorage(updatedTasks);
    setEditingNotes(prev => { const newState = { ...prev }; if (newState[id]) { delete newState[id][noteType]; if (Object.keys(newState[id]).length === 0) delete newState[id]; } return newState; });
  };
  const getNoteValue = (task, noteType) => { if (editingNotes[task.id]?.[noteType] !== undefined) return editingNotes[task.id][noteType]; return safeString(task[noteType]); };

  const [editingEmails, setEditingEmails] = useState({});
  const updateLocalEmail = (id, value) => { setEditingEmails(prev => ({ ...prev, [id]: value })); };
  const saveEmailOnBlur = async (id) => {
    const emailValue = editingEmails[id];
    if (emailValue === undefined) return;
    const updatedTasks = tasks.map(t => t.id === id ? { ...t, emailLink: emailValue } : t);
    setTasks(updatedTasks);
    await saveTasksToStorage(updatedTasks);
    setEditingEmails(prev => { const n = { ...prev }; delete n[id]; return n; });
  };
  const getEmailValue = (task) => { if (editingEmails[task.id] !== undefined) return editingEmails[task.id]; return safeString(task.emailLink); };

  const [expandedNotes, setExpandedNotes] = useState({});
  const toggleNotes = (id) => setExpandedNotes(prev => ({ ...prev, [id]: !prev[id] }));
  const hasNotes = (task) => !!(safeString(task.notesDrK).trim() || safeString(task.notesAthena).trim());

  const toggleUrgent = async (id) => { const updatedTasks = tasks.map(t => t.id === id ? { ...t, urgent: !t.urgent } : t); setTasks(updatedTasks); await saveTasksToStorage(updatedTasks); };
  const setComeBackDate = async (id, date) => { const updatedTasks = tasks.map(t => t.id === id ? { ...t, comeBackDate: date } : t); setTasks(updatedTasks); await saveTasksToStorage(updatedTasks); };
  const clearComeBackDate = async (id) => { const updatedTasks = tasks.map(t => t.id === id ? { ...t, comeBackDate: '' } : t); setTasks(updatedTasks); await saveTasksToStorage(updatedTasks); };

  const isInComeBackTab = (task) => {
    if (!task.comeBackDate) return false;
    const today = new Date(); today.setHours(0, 0, 0, 0);
    const comeBack = new Date(task.comeBackDate + 'T00:00:00');
    return comeBack > today;
  };
  const getActiveTasks = () => tasks.filter(t => !isInComeBackTab(t));
  const getComeBackTasks = () => tasks.filter(t => isInComeBackTab(t)).sort((a, b) => new Date(a.comeBackDate) - new Date(b.comeBackDate));
  const formatComeBackDate = (dateStr) => { if (!dateStr) return ''; const date = new Date(dateStr + 'T12:00:00'); return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); };
  const getDaysUntilComeBack = (dateStr) => { if (!dateStr) return null; const today = new Date(); today.setHours(0, 0, 0, 0); const comeBack = new Date(dateStr + 'T00:00:00'); return Math.ceil((comeBack - today) / (1000 * 60 * 60 * 24)); };

  const startEditTask = (task) => {
    setEditingTaskId(task.id);
    setFormData({ category: safeString(task.category) || 'Review', tag: safeString(task.tag) || 'Office', description: safeString(task.description), emailLink: safeString(task.emailLink), urgent: Boolean(task.urgent), attachments: task.attachments || [], comeBackDate: safeString(task.comeBackDate) });
  };

  const saveEditTask = async () => {
    if (!formData.description.trim()) { alert('Please enter a task description'); return; }
    const editedTask = tasks.find(t => t.id === editingTaskId);
    if (!editedTask) { cancelEditTask(); return; }
    const otherTasks = tasks.filter(t => t.id !== editingTaskId);
    const updatedTask = normalizeTask({ ...editedTask, ...formData });
    const updatedTasks = [updatedTask, ...otherTasks];
    setTasks(updatedTasks);
    await saveTasksToStorage(updatedTasks);
    cancelEditTask();
  };

  const cancelEditTask = () => { setEditingTaskId(null); setFormData({ category: 'Review', tag: 'Office', description: '', emailLink: '', urgent: false, attachments: [], comeBackDate: '' }); };

  // UPDATED: openEmailLink now handles Message-IDs in addition to full URLs
  const openEmailLink = (url) => {
    let link = safeString(url).trim();
    if (!link) return;
    // Strip angle brackets if present: <msgid@domain>
    if (link.startsWith('<') && link.endsWith('>')) {
      link = link.slice(1, -1);
    }
    // If it looks like a Message-ID (has @ but isn't a URL), build Gmail search URL
    if (!link.startsWith('http') && link.includes('@')) {
      link = `https://mail.google.com/mail/u/0/#search/rfc822msgid:${encodeURIComponent(link)}`;
    }
    if (link.startsWith('http')) {
      window.open(link, '_blank', 'noopener,noreferrer');
    }
  };

  // Helper: does the email field have something openable?
  const isOpenable = (val) => {
    let link = safeString(val).trim();
    if (!link) return false;
    if (link.startsWith('<') && link.endsWith('>')) link = link.slice(1, -1);
    return link.startsWith('http') || link.includes('@');
  };

  const addTravelEntry = () => {
    if (!travelForm.description || !travelForm.startDate) { alert('Please enter description and start date'); return; }
    setTravelEntries([...travelEntries, { id: Date.now(), ...travelForm }].sort((a, b) => new Date(a.startDate) - new Date(b.startDate)));
    setTravelForm({ type: 'Flight', description: '', startDate: '', endDate: '', location: '', confirmation: '', url: '', tags: [] });
  };
  const deleteTravelEntry = (id) => { if (window.confirm('Delete this travel entry?')) setTravelEntries(travelEntries.filter(e => e.id !== id)); };
  const startEditTravel = (entry) => { setEditingTravelId(entry.id); setTravelForm({ type: entry.type || 'Flight', description: entry.description || '', startDate: entry.startDate || '', endDate: entry.endDate || '', location: entry.location || '', confirmation: entry.confirmation || '', url: entry.url || '', tags: entry.tags || [] }); };
  const saveEditTravel = () => { setTravelEntries(travelEntries.map(e => e.id === editingTravelId ? { ...e, ...travelForm } : e).sort((a, b) => new Date(a.startDate) - new Date(b.startDate))); setEditingTravelId(null); setTravelForm({ type: 'Flight', description: '', startDate: '', endDate: '', location: '', confirmation: '', url: '', tags: [] }); };
  const cancelEditTravel = () => { setEditingTravelId(null); setTravelForm({ type: 'Flight', description: '', startDate: '', endDate: '', location: '', confirmation: '', url: '', tags: [] }); };

  const getUpcomingTravel = () => {
    const today = new Date(); today.setHours(0, 0, 0, 0);
    return travelEntries.filter(entry => { const startDate = new Date(entry.startDate); startDate.setHours(0, 0, 0, 0); const daysUntil = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24)); return daysUntil >= 0 && daysUntil <= 14; }).map(entry => { const startDate = new Date(entry.startDate); startDate.setHours(0, 0, 0, 0); return { ...entry, daysUntil: Math.ceil((startDate - today) / (1000 * 60 * 60 * 24)) }; });
  };

  const getTravelForDate = (year, month, day) => {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const date = new Date(dateStr);
    return travelEntries.filter(entry => { const start = new Date(entry.startDate); const end = new Date(entry.endDate || entry.startDate); return date >= start && date <= end; });
  };

  const federalHolidays = [
    { date: '2026-01-01', name: "New Year's Day" }, { date: '2026-01-19', name: "Martin Luther King Jr. Day" },
    { date: '2026-02-16', name: "Presidents' Day" }, { date: '2026-05-25', name: "Memorial Day" },
    { date: '2026-06-19', name: "Juneteenth" }, { date: '2026-07-03', name: "Independence Day (Observed)" },
    { date: '2026-07-04', name: "Independence Day" }, { date: '2026-09-07', name: "Labor Day" },
    { date: '2026-10-12', name: "Columbus Day" }, { date: '2026-11-11', name: "Veterans Day" },
    { date: '2026-11-26', name: "Thanksgiving Day" }, { date: '2026-12-25', name: "Christmas Day" }
  ];
  const getHoliday = (year, month, day) => { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; return federalHolidays.find(h => h.date === dateStr); };

  const Calendar = ({ year }) => {
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const getDaysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
    const getFirstDayOfMonth = (y, m) => new Date(y, m, 1).getDay();
    const renderMonth = (monthIndex) => {
      const daysInMonth = getDaysInMonth(year, monthIndex);
      const firstDay = getFirstDayOfMonth(year, monthIndex);
      const days = [];
      for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-7"></div>);
      for (let day = 1; day <= daysInMonth; day++) {
        const travel = getTravelForDate(year, monthIndex, day);
        const holiday = getHoliday(year, monthIndex, day);
        const isToday = new Date().toDateString() === new Date(year, monthIndex, day).toDateString();
        const isWeekend = new Date(year, monthIndex, day).getDay() === 0 || new Date(year, monthIndex, day).getDay() === 6;
        let bgColor = ''; let textColor = isWeekend ? 'text-blue-400' : 'text-gray-800'; let title = '';
        if (travel.length > 0) { bgColor = 'bg-cyan-400'; textColor = 'text-white font-bold'; title = travel.map(t => t.description).join(', '); }
        else if (holiday) { bgColor = 'bg-red-100'; textColor = 'text-red-700'; title = holiday.name; }
        if (isToday) { bgColor = bgColor || 'bg-indigo-500'; textColor = 'text-white font-bold'; }
        days.push(<div key={day} className={`h-7 w-7 flex items-center justify-center text-xs rounded ${bgColor} ${textColor} cursor-default`} title={title}>{day}</div>);
      }
      return (
        <div key={monthIndex} className="bg-white rounded-lg shadow p-2">
          <div className="bg-blue-800 text-white text-center py-1 rounded text-sm font-bold mb-1">{months[monthIndex]} '{String(year).slice(2)}</div>
          <div className="grid grid-cols-7 gap-0.5 text-center text-xs mb-1">{['Su', 'M', 'Tu', 'W', 'Th', 'F', 'Sa'].map(d => <div key={d} className="font-semibold text-gray-600">{d}</div>)}</div>
          <div className="grid grid-cols-7 gap-0.5">{days}</div>
        </div>
      );
    };
    return (
      <div className="space-y-4">
        <div className="flex justify-between items-center">
          <button onClick={() => setCalendarYear(y => y - 1)} className="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">â† {year - 1}</button>
          <h3 className="text-xl font-bold">{year} Calendar</h3>
          <button onClick={() => setCalendarYear(y => y + 1)} className="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">{year + 1} â†’</button>
        </div>
        <div className="flex gap-4 text-xs flex-wrap">
          <span className="flex items-center gap-1"><span className="w-4 h-4 bg-cyan-400 rounded"></span> Travel</span>
          <span className="flex items-center gap-1"><span className="w-4 h-4 bg-red-100 border rounded"></span> Holiday</span>
          <span className="flex items-center gap-1"><span className="w-4 h-4 bg-indigo-500 rounded"></span> Today</span>
        </div>
        <div className="text-center font-bold text-gray-600">Q1 {year}</div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">{[0, 1, 2].map(m => renderMonth(m))}</div>
        <div className="text-center font-bold text-gray-600 mt-4">Q2 {year}</div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">{[3, 4, 5].map(m => renderMonth(m))}</div>
        <div className="text-center font-bold text-gray-600 mt-4">Q3 {year}</div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">{[6, 7, 8].map(m => renderMonth(m))}</div>
        <div className="text-center font-bold text-gray-600 mt-4">Q4 {year}</div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">{[9, 10, 11].map(m => renderMonth(m))}</div>
      </div>
    );
  };

  const toggleDarkMode = () => { setDarkMode(d => { localStorage.setItem('darkMode', (!d).toString()); return !d; }); };

  const generateRecap = () => {
    if (tasks.length === 0) { alert('No tasks to recap.'); return; }
    setRecapText('');
    const today = new Date();
    const day = today.getDate();
    const suffix = day % 10 === 1 && day !== 11 ? 'st' : day % 10 === 2 && day !== 12 ? 'nd' : day % 10 === 3 && day !== 13 ? 'rd' : 'th';
    const formattedDate = today.toLocaleDateString('en-US', { weekday: 'long', month: 'long' }) + ' ' + day + suffix;
    const sectionOrder = [
      ["THIS WEEK'S PROJECTS", tasks.filter(t => t.tag === "This Week's Projects" && !t.completed)],
      ["REAL ESTATE", tasks.filter(t => t.tag === 'Real Estate' && !t.completed)],
      ["DR. RESPONSE", tasks.filter(t => t.tag === 'Dr. Response' && !t.completed)],
      ["OFFICE", tasks.filter(t => t.tag === 'Office' && !t.completed)],
      ["FINANCE", tasks.filter(t => t.tag === 'Finance' && !t.completed)],
      ["TRAVEL", tasks.filter(t => t.tag === 'Travel' && !t.completed)],
      ["PERSONAL", tasks.filter(t => t.tag === 'Personal' && !t.completed)],
      ["OTHER", tasks.filter(t => !["This Week's Projects",'Real Estate','Dr. Response','Office','Finance','Travel','Personal'].includes(t.tag) && !t.completed)]
    ];
    let recap = `Hi Dr. Koch, here is your Daily Recap for ${formattedDate} in order of action item:\n\n`;
    sectionOrder.forEach(([name, items]) => {
      if (items.length > 0) {
        recap += `${name}\n`;
        items.forEach(t => { recap += `â€¢ [${t.category}] ${safeString(t.description)}\n`; });
        recap += `\n`;
      }
    });
    recap += `---\nTotal: ${tasks.length} | Done: ${tasks.filter(t => t.completed).length} | Remaining: ${tasks.filter(t => !t.completed).length}`;
    setTimeout(() => setRecapText(recap), 0);
  };

  const groupTasksBySection = (taskList) => {
    const sections = { "THIS WEEK'S PROJECTS": [], "REAL ESTATE": [], "DR. RESPONSE": [], "OFFICE RELATED": [], "FINANCE RELATED": [], "TRAVEL RELATED": [], "PERSONAL RELATED": [], "OTHER": [] };
    taskList.forEach(task => {
      if (!task) return;
      const tag = safeString(task.tag);
      if (tag === "This Week's Projects") sections["THIS WEEK'S PROJECTS"].push(task);
      else if (tag === 'Real Estate') sections["REAL ESTATE"].push(task);
      else if (tag === 'Dr. Response') sections["DR. RESPONSE"].push(task);
      else if (tag === 'Finance') sections["FINANCE RELATED"].push(task);
      else if (tag === 'Office') sections["OFFICE RELATED"].push(task);
      else if (tag === 'Travel') sections["TRAVEL RELATED"].push(task);
      else if (tag === 'Personal') sections["PERSONAL RELATED"].push(task);
      else sections["OTHER"].push(task);
    });
    return Object.entries(sections).filter(([_, t]) => t.length > 0);
  };

  const getSectionColor = (name) => {
    if (name.includes("WEEK'S PROJECTS")) return 'bg-gradient-to-r from-rose-600 to-pink-500';
    if (name.includes('REAL ESTATE')) return 'bg-gradient-to-r from-emerald-600 to-emerald-500';
    if (name.includes('DR. RESPONSE')) return 'bg-gradient-to-r from-indigo-600 to-indigo-500';
    if (name.includes('FINANCE')) return 'bg-gradient-to-r from-purple-600 to-purple-500';
    if (name.includes('OFFICE')) return 'bg-gradient-to-r from-blue-600 to-blue-500';
    if (name.includes('TRAVEL')) return 'bg-gradient-to-r from-cyan-600 to-cyan-500';
    if (name.includes('PERSONAL')) return 'bg-gradient-to-r from-orange-600 to-orange-500';
    return 'bg-gradient-to-r from-gray-600 to-gray-500';
  };

  const renderDescription = (text) => {
    const str = safeString(text);
    if (!str) return '';
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return str.split(urlRegex).map((part, i) => part.match(urlRegex) ? <a key={i} href={part} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 underline break-all">{part.length > 40 ? part.substring(0, 40) + '...' : part}</a> : part);
  };

  const getBadgeClass = (type, value) => {
    const classes = {
      category: { 'Review': 'bg-pink-100 text-pink-800', 'Sign': 'bg-yellow-100 text-yellow-800', 'Appointment': 'bg-cyan-100 text-cyan-800', 'Approve': 'bg-emerald-100 text-emerald-800', 'Respond': 'bg-blue-100 text-blue-800', 'No Action Needed': 'bg-gray-100 text-gray-800', 'PAY': 'bg-lime-100 text-lime-800', 'Hold': 'bg-slate-700 text-white', 'Errands': 'bg-amber-100 text-amber-800', 'Dr. Response': 'bg-indigo-100 text-indigo-800' },
      tag: { "This Week's Projects": 'bg-rose-100 text-rose-700', 'Real Estate': 'bg-emerald-100 text-emerald-700', 'Dr. Response': 'bg-indigo-100 text-indigo-700', 'Office': 'bg-blue-100 text-blue-700', 'Finance': 'bg-green-100 text-green-700', 'Travel': 'bg-cyan-100 text-cyan-700', 'Personal': 'bg-purple-100 text-purple-700', 'Other': 'bg-gray-100 text-gray-700' }
    };
    return classes[type]?.[value] || 'bg-gray-100 text-gray-700';
  };

  const quotes = [
    { quote: "Feeling is the prayer.", author: "Gregg Braden" },
    { quote: "Change the way you look at things and the things you look at change.", author: "Wayne Dyer" },
    { quote: "Where focus goes, energy flows.", author: "Tony Robbins" },
    { quote: "Assume the feeling of your wish fulfilled.", author: "Neville Goddard" },
    { quote: "The basis of your life is absolute freedom, the goal is joy.", author: "Esther Hicks" }
  ];
  const dailyQuote = quotes[new Date().getDay() % quotes.length];

  const activeTasks = getActiveTasks();
  const filteredTasks = currentFilter === 'all' ? activeTasks : activeTasks.filter(t => t.category === currentFilter);
  const groupedTasks = groupTasksBySection(filteredTasks);
  const comeBackTasks = getComeBackTasks();

  const taskEditForm = (onSave, onCancel) => (
    <div className="space-y-3">
      <div className="flex justify-between"><span className="font-bold text-blue-700">âœï¸ Editing</span><button onClick={onCancel}>âœ•</button></div>
      <div className="grid grid-cols-2 gap-2">
        <select value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})} className="px-2 py-1.5 border rounded text-sm">
          <option>Review</option><option>Sign</option><option>Appointment</option><option>Approve</option><option>Respond</option><option>No Action Needed</option><option>PAY</option><option>Hold</option><option>Errands</option><option>Dr. Response</option>
        </select>
        <select value={formData.tag} onChange={(e) => setFormData({...formData, tag: e.target.value})} className="px-2 py-1.5 border rounded text-sm">
          <option>This Week's Projects</option><option>Real Estate</option><option>Dr. Response</option><option>Office</option><option>Finance</option><option>Travel</option><option>Personal</option><option>Other</option>
        </select>
      </div>
      <textarea value={formData.description} onChange={(e) => setFormData({...formData, description: e.target.value})} className="w-full px-3 py-2 border rounded text-sm min-h-24" />
      <input type="text" value={formData.emailLink} onChange={(e) => setFormData({...formData, emailLink: e.target.value})} placeholder="Email link or Message-ID" className="w-full px-3 py-2 border rounded text-sm" />
      <div className="flex items-center gap-3 flex-wrap">
        <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={formData.urgent} onChange={(e) => setFormData({...formData, urgent: e.target.checked})} /> Urgent</label>
        <div className="flex items-center gap-2">
          <span className="text-sm text-gray-600">ğŸ”„ Come back:</span>
          <input type="date" value={formData.comeBackDate || ''} onChange={(e) => setFormData({...formData, comeBackDate: e.target.value})} className="px-2 py-1 border rounded text-sm" min={new Date().toISOString().split('T')[0]} />
        </div>
      </div>
      <div className="flex gap-2">
        <button onClick={onSave} className="flex-1 py-2 bg-blue-500 text-white rounded-lg">âœ“ Save</button>
        <button onClick={onCancel} className="flex-1 py-2 bg-gray-300 rounded-lg">Cancel</button>
      </div>
    </div>
  );

  const taskCard = (task, extraBadge) => (
    <>
      <div className="flex justify-between items-start mb-2">
        <div className="flex gap-2 flex-wrap">
          {extraBadge}
          <span className={`px-3 py-1 rounded-md text-xs font-semibold uppercase ${getBadgeClass('category', task.category)}`}>{task.category}</span>
          <span className={`px-3 py-1 rounded-md text-xs font-semibold uppercase ${getBadgeClass('tag', task.tag)}`}>{task.tag}</span>
          {task.carriedOver && <span className="px-3 py-1 rounded-md text-xs font-semibold bg-orange-100 text-orange-800">ğŸ“… Carried</span>}
        </div>
        <div className="flex gap-1">
          <button onClick={() => startEditTask(task)} className="w-7 h-7 bg-blue-100 hover:bg-blue-200 rounded flex items-center justify-center text-xs">âœï¸</button>
          <button onClick={() => toggleUrgent(task.id)} className={`w-7 h-7 rounded flex items-center justify-center text-xs ${task.urgent ? 'bg-yellow-400' : 'bg-gray-100 hover:bg-gray-200'}`}>âš¡</button>
          <button onClick={() => toggleComplete(task.id)} className={`w-7 h-7 rounded flex items-center justify-center ${task.completed ? 'bg-green-200' : 'bg-gray-100 hover:bg-gray-200'}`}>{task.completed ? 'âœ“' : 'â—‹'}</button>
          <button onClick={() => deleteTask(task.id)} className="w-7 h-7 bg-gray-100 hover:bg-red-100 rounded flex items-center justify-center">Ã—</button>
        </div>
      </div>
      <p className={`text-sm mb-2 ${task.completed ? 'line-through' : ''}`}>{renderDescription(task.description)}</p>
      <div className="mt-2 flex items-center gap-2">
        <span className="text-sm">ğŸ“§</span>
        <input type="text" value={getEmailValue(task)} onChange={(e) => updateLocalEmail(task.id, e.target.value)} onBlur={() => saveEmailOnBlur(task.id)} placeholder="Paste email link or Message-ID..." className="flex-1 px-2 py-1 border border-gray-200 rounded text-xs bg-white focus:border-blue-400 focus:ring-1 focus:ring-blue-200 outline-none" />
        {isOpenable(getEmailValue(task)) && (
          <button onClick={() => openEmailLink(getEmailValue(task))} className="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold rounded whitespace-nowrap">Open â†—</button>
        )}
      </div>
    </>
  );

  return (
    <div className={`min-h-screen p-4 ${darkMode ? 'bg-gradient-to-br from-gray-900 to-gray-800' : 'bg-gradient-to-br from-indigo-600 to-purple-700'}`}>
      <div className="max-w-6xl mx-auto">
        <div className={`rounded-2xl shadow-2xl p-6 mb-6 ${darkMode ? 'bg-gray-800 text-white' : 'bg-white'}`}>
          <div className="flex justify-between items-center flex-wrap gap-4">
            <div>
              <h1 className={`text-3xl font-serif font-bold mb-2 ${darkMode ? 'text-white' : 'text-indigo-900'}`}>Dr. K Workflow <span className="text-xs font-normal text-gray-400 align-middle">v2.4</span></h1>
              <p className={darkMode ? 'text-gray-300' : 'text-gray-600'}>{new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>
              <div className={`mt-3 p-3 rounded-lg border-l-4 ${darkMode ? 'bg-gray-700 border-purple-400' : 'bg-purple-50 border-purple-500'}`}>
                <p className={`text-sm italic ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>"{dailyQuote.quote}"</p>
                <p className={`text-xs font-semibold mt-1 ${darkMode ? 'text-purple-300' : 'text-purple-700'}`}>â€” {dailyQuote.author}</p>
              </div>
            </div>
            <div className="flex gap-3 items-center flex-wrap">
              {isSaving && <span className="text-sm text-yellow-600">â³ Saving...</span>}
              {lastSaveTime && !isSaving && !saveError && <span className="text-xs text-green-600">âœ“ Saved {lastSaveTime}</span>}
              {saveError && (<div className="flex items-center gap-2"><span className="text-xs text-red-600">âš ï¸ {saveError}</span><button onClick={restoreFromBackup} className="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Restore</button></div>)}
              <button onClick={loadTasksFromStorage} disabled={isLoading} className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50">{isLoading ? 'â³' : 'ğŸ”„'} Sync</button>
              <button onClick={toggleDarkMode} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">{darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}</button>
              <button onClick={onLogout} className="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200">ğŸšª Logout</button>
            </div>
          </div>
          <div className="flex gap-2 mt-6 border-b-2 flex-wrap">
            {[['tasks', 'ğŸ“‹ Tasks'], ['comeback', `ğŸ”„ Come Back${comeBackTasks.length > 0 ? ` (${comeBackTasks.length})` : ''}`], ['newhires', `ğŸ‘¤ New Hires${newHires.length > 0 ? ` (${newHires.length})` : ''}`], ['contacts', 'ğŸ“‡ Contacts'], ['travel', 'âœˆï¸ Travel'], ['instructions', 'ğŸ“– Help']].map(([key, label]) => (
              <button key={key} onClick={() => setActiveSection(key)} className={`px-6 py-3 font-semibold relative ${activeSection === key ? 'text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>
                {label}{activeSection === key && <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-indigo-600"></div>}
              </button>
            ))}
          </div>
        </div>

        {/* Instructions Tab */}
        {activeSection === 'instructions' && (
          <div className={`rounded-2xl shadow-2xl p-8 ${darkMode ? 'bg-gray-800 text-white' : 'bg-white'}`}>
            <h2 className="text-2xl font-bold mb-6">How to Use</h2>
            <div className="space-y-4">
              <div className="p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
                <h3 className="font-bold text-blue-900">ğŸ“§ Email Links & Message IDs</h3>
                <p className="text-blue-800 mt-1">Paste a full Gmail URL <strong>or</strong> a raw Message-ID (with or without angle brackets) into the email field. Click <strong>Open â†—</strong> to open the email in Gmail.</p>
              </div>
              <div className="p-4 bg-green-50 border-l-4 border-green-500 rounded-r-lg">
                <h3 className="font-bold text-green-900">ğŸ’¾ Auto-Save</h3>
                <p className="text-green-800 mt-1">Tasks automatically save every <strong>5 minutes</strong>. A local backup is also kept.</p>
              </div>
              <div className="p-4 bg-amber-50 border-l-4 border-amber-500 rounded-r-lg">
                <h3 className="font-bold text-amber-900">âœï¸ Edit = Move to Top</h3>
                <p className="text-amber-800 mt-1">When you edit a task, it automatically moves to the <strong>top of its category</strong> for visibility.</p>
              </div>
              <div className="p-4 bg-orange-50 border-l-4 border-orange-500 rounded-r-lg">
                <h3 className="font-bold text-orange-900">ğŸ”„ Come Back Later</h3>
                <p className="text-orange-800 mt-1">Set a <strong>"Come back"</strong> date on any task to temporarily move it to the Come Back tab. It will automatically return to Tasks on that date!</p>
              </div>
              <div className="p-4 bg-gray-50 rounded-lg">
                <h3 className="font-bold mb-2">Button Guide:</h3>
                <div className="grid grid-cols-2 gap-2 text-sm">
                  <span>âœï¸ Edit task</span><span>âš¡ Toggle urgent</span>
                  <span>â—‹/âœ“ Complete</span><span>Ã— Delete</span>
                  <span>â†©ï¸ Bring back now</span><span>ğŸ”„ Schedule come back</span>
                </div>
              </div>
              <div className="p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
                <h3 className="font-bold text-blue-900">ğŸ’¾ Notes Save Automatically</h3>
                <p className="text-blue-800 mt-1">Notes save when you <strong>click outside</strong> the text box.</p>
              </div>
              <button onClick={generateRecap} className="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">âœ¨ Generate Daily Recap</button>
              {recapText && (
                <div className="space-y-3">
                  <textarea value={recapText} onChange={(e) => setRecapText(e.target.value)} className="w-full min-h-48 p-3 border rounded-lg text-sm font-mono" />
                  <button onClick={() => { navigator.clipboard.writeText(recapText); alert('Copied!'); }} className="w-full py-2 bg-amber-500 text-white rounded-lg">ğŸ“‹ Copy</button>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Tasks Tab */}
        {activeSection === 'tasks' && (
          <div className={`rounded-2xl shadow-2xl p-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
            <h2 className={`text-2xl font-serif font-bold mb-6 pb-4 border-b-2 ${darkMode ? 'text-white border-gray-600' : 'text-indigo-900 border-gray-200'}`}>Today's Tasks</h2>
            <div className="flex flex-wrap gap-2 mb-4">
              {['all', 'Review', 'Sign', 'Appointment', 'Approve', 'Respond', 'No Action Needed', 'PAY', 'Hold', 'Errands', 'Dr. Response'].map(f => (
                <button key={f} onClick={() => setCurrentFilter(f)} className={`px-3 py-1.5 rounded-lg text-xs font-medium ${currentFilter === f ? 'bg-indigo-600 text-white' : darkMode ? 'bg-gray-700 text-gray-300' : 'bg-white border hover:bg-gray-50'}`}>{f === 'all' ? 'All' : f}</button>
              ))}
            </div>
            <div className="space-y-6">
              {isLoading ? (
                <div className="text-center py-12"><div className="text-5xl mb-4">â³</div><p>Loading...</p></div>
              ) : filteredTasks.length === 0 ? (
                <div className="text-center py-12"><div className="text-5xl mb-4">ğŸ“‹</div><p>No tasks</p></div>
              ) : (
                groupedTasks.map(([sectionName, sectionTasks]) => (
                  <div key={sectionName}>
                    <div className={`${getSectionColor(sectionName)} text-white px-4 py-3 rounded-t-lg font-bold text-sm uppercase`}>{sectionName}</div>
                    <div className="space-y-3 bg-gray-50 p-4 rounded-b-lg border border-t-0">
                      {sectionTasks.map(task => (
                        <div key={task.id} className={`border rounded-xl p-4 ${editingTaskId === task.id ? 'bg-blue-50 border-blue-400 ring-2 ring-blue-300' : task.urgent ? 'bg-yellow-50 border-yellow-400' : 'bg-white'} ${task.completed ? 'opacity-60' : ''}`}>
                          {editingTaskId === task.id ? taskEditForm(saveEditTask, cancelEditTask) : (
                            <>
                              {taskCard(task, null)}
                              <div className="mt-3 flex items-center gap-2 flex-wrap">
                                <span className="text-xs font-semibold text-gray-600">ğŸ”„ Come back:</span>
                                <input type="date" value={task.comeBackDate || ''} onChange={(e) => setComeBackDate(task.id, e.target.value)} className="px-2 py-1 border rounded text-xs" min={new Date().toISOString().split('T')[0]} />
                                {task.comeBackDate && <button onClick={() => clearComeBackDate(task.id)} className="px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs">Clear</button>}
                              </div>
                              <div className="mt-4 pt-4 border-t-2">
                                <button onClick={() => toggleNotes(task.id)} className={`px-3 py-1.5 rounded-lg text-xs font-semibold ${hasNotes(task) ? 'bg-amber-100 text-amber-800' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                                  ğŸ“ Notes {hasNotes(task) ? '(has notes)' : ''} {expandedNotes[task.id] ? 'â–²' : 'â–¼'}
                                </button>
                                {expandedNotes[task.id] && (
                                  <div className="mt-3 space-y-3">
                                    <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3">
                                      <label className="block text-xs font-bold text-blue-800 uppercase mb-2">ğŸ‘¨â€âš•ï¸ Dr. K's Notes</label>
                                      <textarea value={getNoteValue(task, 'notesDrK')} onChange={(e) => updateLocalNote(task.id, 'notesDrK', e.target.value)} onBlur={() => saveNoteOnBlur(task.id, 'notesDrK')} placeholder="Dr. Koch's comments..." className="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm min-h-16 bg-white" />
                                    </div>
                                    <div className="bg-purple-50 border-2 border-purple-200 rounded-lg p-3">
                                      <label className="block text-xs font-bold text-purple-800 uppercase mb-2">ğŸ‘©â€ğŸ’¼ Athena's Notes</label>
                                      <textarea value={getNoteValue(task, 'notesAthena')} onChange={(e) => updateLocalNote(task.id, 'notesAthena', e.target.value)} onBlur={() => saveNoteOnBlur(task.id, 'notesAthena')} placeholder="Athena's updates..." className="w-full px-3 py-2 border-2 border-purple-300 rounded-lg text-sm min-h-16 bg-white" />
                                    </div>
                                  </div>
                                )}
                              </div>
                            </>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                ))
              )}
            </div>
            <div className="bg-indigo-50 border-2 border-indigo-200 rounded-xl p-5 my-6">
              <div className="grid grid-cols-5 gap-3 text-center">
                <div className="bg-white rounded-lg p-3"><div className="text-2xl font-bold text-indigo-600">{activeTasks.length}</div><div className="text-xs">Active</div></div>
                <div className="bg-white rounded-lg p-3"><div className="text-2xl font-bold text-green-600">{tasks.filter(t => t.completed).length}</div><div className="text-xs">Done</div></div>
                <div className="bg-white rounded-lg p-3"><div className="text-2xl font-bold text-yellow-600">{tasks.filter(t => t.urgent && !t.completed).length}</div><div className="text-xs">Urgent</div></div>
                <div className="bg-white rounded-lg p-3"><div className="text-2xl font-bold text-amber-600">{comeBackTasks.length}</div><div className="text-xs">Come Back</div></div>
                <div className="bg-white rounded-lg p-3"><div className="text-2xl font-bold text-gray-600">{tasks.length}</div><div className="text-xs">Total</div></div>
              </div>
            </div>
            <div className="mt-8 pt-6 border-t-2">
              <h3 className={`text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-indigo-900'}`}>â• Add Task</h3>
              <div className="bg-gray-50 rounded-xl p-5 space-y-3">
                <div className="grid grid-cols-2 gap-3">
                  <select value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})} className="px-3 py-2 border rounded-lg text-sm">
                    <option>Review</option><option>Sign</option><option>Appointment</option><option>Approve</option><option>Respond</option><option>No Action Needed</option><option>PAY</option><option>Hold</option><option>Errands</option><option>Dr. Response</option>
                  </select>
                  <select value={formData.tag} onChange={(e) => setFormData({...formData, tag: e.target.value})} className="px-3 py-2 border rounded-lg text-sm">
                    <option>This Week's Projects</option><option>Real Estate</option><option>Dr. Response</option><option>Office</option><option>Finance</option><option>Travel</option><option>Personal</option><option>Other</option>
                  </select>
                </div>
                <textarea value={formData.description} onChange={(e) => setFormData({...formData, description: e.target.value})} placeholder="Task description..." className="w-full px-3 py-2 border rounded-lg text-sm min-h-20" />
                <input type="text" value={formData.emailLink} onChange={(e) => setFormData({...formData, emailLink: e.target.value})} placeholder="Email link or Message-ID" className="w-full px-3 py-2 border rounded-lg text-sm" />
                <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={formData.urgent} onChange={(e) => setFormData({...formData, urgent: e.target.checked})} /> Mark Urgent</label>
                {!editingTaskId && <button onClick={addTask} className="w-full py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium">â• Add Task</button>}
              </div>
            </div>
          </div>
        )}

        {/* Come Back Tab */}
        {activeSection === 'comeback' && (
          <div className={`rounded-2xl shadow-2xl p-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
            <h2 className={`text-2xl font-serif font-bold mb-6 pb-4 border-b-2 ${darkMode ? 'text-white border-gray-600' : 'text-indigo-900 border-gray-200'}`}>ğŸ”„ Come Back Later</h2>
            <div className="mb-4 p-4 bg-amber-50 border-l-4 border-amber-500 rounded-r-lg">
              <p className="text-amber-800 text-sm">Tasks here will automatically move back to the <strong>Tasks</strong> tab on their scheduled date.</p>
            </div>
            <div className="space-y-4">
              {comeBackTasks.length === 0 ? (
                <div className="text-center py-12"><div className="text-5xl mb-4">ğŸ“…</div><p className={darkMode ? 'text-gray-400' : 'text-gray-500'}>No tasks scheduled to come back</p></div>
              ) : (
                comeBackTasks.map(task => {
                  const daysUntil = getDaysUntilComeBack(task.comeBackDate);
                  return (
                    <div key={task.id} className={`border rounded-xl p-4 ${editingTaskId === task.id ? 'bg-blue-50 border-blue-400 ring-2 ring-blue-300' : task.urgent ? 'bg-yellow-50 border-yellow-400' : 'bg-white'}`}>
                      {editingTaskId === task.id ? taskEditForm(saveEditTask, cancelEditTask) : (
                        <>
                          {taskCard(task, (
                            <span className="px-3 py-1 rounded-md text-xs font-semibold bg-amber-100 text-amber-800">
                              ğŸ“… {formatComeBackDate(task.comeBackDate)}{daysUntil === 1 ? ' (Tomorrow!)' : daysUntil <= 7 ? ` (${daysUntil} days)` : ''}
                            </span>
                          ))}
                          <div className="mt-2 flex items-center gap-2">
                            <button onClick={() => clearComeBackDate(task.id)} className="px-2 py-1 bg-green-100 hover:bg-green-200 rounded text-xs" title="Bring back now">â†©ï¸ Bring back now</button>
                            <span className="text-xs text-gray-500">or change date:</span>
                            <input type="date" value={task.comeBackDate || ''} onChange={(e) => setComeBackDate(task.id, e.target.value)} className="px-2 py-1 border rounded text-xs" min={new Date().toISOString().split('T')[0]} />
                          </div>
                          <div className="mt-3">
                            <button onClick={() => toggleNotes(task.id)} className={`px-3 py-1.5 rounded-lg text-xs font-semibold ${hasNotes(task) ? 'bg-amber-100 text-amber-800' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                              ğŸ“ Notes {hasNotes(task) ? '(has notes)' : ''} {expandedNotes[task.id] ? 'â–²' : 'â–¼'}
                            </button>
                            {expandedNotes[task.id] && (
                              <div className="mt-3 space-y-3">
                                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3">
                                  <label className="block text-xs font-bold text-blue-800 uppercase mb-2">ğŸ‘¨â€âš•ï¸ Dr. K's Notes</label>
                                  <textarea value={getNoteValue(task, 'notesDrK')} onChange={(e) => updateLocalNote(task.id, 'notesDrK', e.target.value)} onBlur={() => saveNoteOnBlur(task.id, 'notesDrK')} placeholder="Dr. Koch's comments..." className="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm min-h-16 bg-white" />
                                </div>
                                <div className="bg-purple-50 border-2 border-purple-200 rounded-lg p-3">
                                  <label className="block text-xs font-bold text-purple-800 uppercase mb-2">ğŸ‘©â€ğŸ’¼ Athena's Notes</label>
                                  <textarea value={getNoteValue(task, 'notesAthena')} onChange={(e) => updateLocalNote(task.id, 'notesAthena', e.target.value)} onBlur={() => saveNoteOnBlur(task.id, 'notesAthena')} placeholder="Athena's updates..." className="w-full px-3 py-2 border-2 border-purple-300 rounded-lg text-sm min-h-16 bg-white" />
                                </div>
                              </div>
                            )}
                          </div>
                        </>
                      )}
                    </div>
                  );
                })
              )}
            </div>
            {comeBackTasks.length > 0 && (
              <div className="mt-6 p-4 bg-gray-100 rounded-lg">
                <div className="text-sm text-gray-600">
                  <strong>{comeBackTasks.length}</strong> task{comeBackTasks.length !== 1 ? 's' : ''} scheduled
                  {comeBackTasks.filter(t => getDaysUntilComeBack(t.comeBackDate) <= 7).length > 0 && <span className="ml-2 text-amber-600">â€¢ {comeBackTasks.filter(t => getDaysUntilComeBack(t.comeBackDate) <= 7).length} within the next week</span>}
                </div>
              </div>
            )}
          </div>
        )}

        {/* New Hires Tab */}
        {activeSection === 'newhires' && (
          <div className={`rounded-2xl shadow-2xl p-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
            <h2 className={`text-2xl font-serif font-bold mb-6 pb-4 border-b-2 ${darkMode ? 'text-white border-gray-600' : 'text-indigo-900 border-gray-200'}`}>ğŸ‘¤ New Hires</h2>

            {/* New Hire Cards */}
            {newHires.length === 0 ? (
              <div className="text-center py-12 mb-6"><div className="text-5xl mb-4">ğŸ‘¥</div><p className={darkMode ? 'text-gray-400' : 'text-gray-500'}>No new hire records yet</p></div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                {newHires.map(hire => (
                  <div key={hire.id} className={`border rounded-xl p-4 ${editingNewHireId === hire.id ? 'bg-blue-50 border-blue-400 ring-2 ring-blue-300' : 'bg-white'} hover:shadow-md transition-shadow`}>
                    {editingNewHireId === hire.id ? (
                      <div className="space-y-3">
                        <div className="flex justify-between"><span className="font-bold text-blue-700">âœï¸ Editing</span><button onClick={cancelEditNewHire} className="text-gray-500 hover:text-gray-700">âœ•</button></div>
                        <div className="flex flex-col items-center gap-2 mb-2">
                          {newHireForm.photo && <img src={newHireForm.photo} alt="Preview" className="w-24 h-24 rounded-full object-cover border-2 border-indigo-300" />}
                          <label className="cursor-pointer px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded-lg text-sm hover:bg-indigo-200">
                            ğŸ“· {newHireForm.photo ? 'Change Photo' : 'Upload Photo'}
                            <input type="file" accept="image/*" onChange={handleNewHirePhoto} className="hidden" />
                          </label>
                          {newHireForm.photo && <button onClick={() => setNewHireForm(prev => ({...prev, photo: ''}))} className="text-xs text-red-500 hover:text-red-700">Remove photo</button>}
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                          <input type="text" value={newHireForm.name} onChange={(e) => setNewHireForm({...newHireForm, name: e.target.value})} placeholder="Full Name *" className="px-3 py-2 border rounded-lg text-sm" />
                          <input type="text" value={newHireForm.position} onChange={(e) => setNewHireForm({...newHireForm, position: e.target.value})} placeholder="Position/Title" className="px-3 py-2 border rounded-lg text-sm" />
                          <input type="text" value={newHireForm.department} onChange={(e) => setNewHireForm({...newHireForm, department: e.target.value})} placeholder="Department" className="px-3 py-2 border rounded-lg text-sm" />
                          <input type="date" value={newHireForm.startDate} onChange={(e) => setNewHireForm({...newHireForm, startDate: e.target.value})} className="px-3 py-2 border rounded-lg text-sm" />
                          <input type="tel" value={newHireForm.phone} onChange={(e) => setNewHireForm({...newHireForm, phone: e.target.value})} placeholder="Phone" className="px-3 py-2 border rounded-lg text-sm" />
                          <input type="email" value={newHireForm.email} onChange={(e) => setNewHireForm({...newHireForm, email: e.target.value})} placeholder="Email" className="px-3 py-2 border rounded-lg text-sm" />
                        </div>
                        <textarea value={newHireForm.notes} onChange={(e) => setNewHireForm({...newHireForm, notes: e.target.value})} placeholder="Notes (equipment needed, onboarding tasks, etc.)" className="w-full px-3 py-2 border rounded-lg text-sm min-h-20" />
                        <div className="flex gap-2"><button onClick={saveEditNewHire} className="flex-1 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">âœ“ Save</button><button onClick={cancelEditNewHire} className="flex-1 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancel</button></div>
                      </div>
                    ) : (
                      <div>
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex items-center gap-3">
                            {hire.photo
                              ? <img src={hire.photo} alt={hire.name} className="w-14 h-14 rounded-full object-cover border-2 border-indigo-200" />
                              : <div className="w-14 h-14 rounded-full bg-indigo-100 flex items-center justify-center text-2xl border-2 border-indigo-200">ğŸ‘¤</div>
                            }
                            <div>
                              <h3 className="font-bold text-gray-900 text-lg">{hire.name}</h3>
                              {hire.position && <p className="text-sm text-indigo-600 font-medium">{hire.position}</p>}
                            </div>
                          </div>
                          <div className="flex gap-1">
                            <button onClick={() => startEditNewHire(hire)} className="w-7 h-7 bg-blue-100 hover:bg-blue-200 rounded flex items-center justify-center text-xs">âœï¸</button>
                            <button onClick={() => deleteNewHire(hire.id)} className="w-7 h-7 bg-gray-100 hover:bg-red-100 rounded flex items-center justify-center text-xs">Ã—</button>
                          </div>
                        </div>
                        <div className="space-y-1 text-sm">
                          {hire.department && <div className="flex items-center gap-2"><span className="text-gray-400">ğŸ¢</span><span className="text-gray-700">{hire.department}</span></div>}
                          {hire.startDate && <div className="flex items-center gap-2"><span className="text-gray-400">ğŸ“…</span><span className="text-gray-700">Start: {new Date(hire.startDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span></div>}
                          {hire.phone && <div className="flex items-center gap-2"><span className="text-gray-400">ğŸ“</span><a href={`tel:${hire.phone}`} className="text-blue-600 hover:underline">{hire.phone}</a></div>}
                          {hire.email && <div className="flex items-center gap-2"><span className="text-gray-400">âœ‰ï¸</span><a href={`mailto:${hire.email}`} className="text-blue-600 hover:underline break-all">{hire.email}</a></div>}
                          {hire.notes && <div className="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600">ğŸ“ {hire.notes}</div>}
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}

            {/* Add New Hire Form */}
            <div className="pt-6 border-t-2">
              <h3 className={`text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-indigo-900'}`}>â• Add New Hire</h3>
              <div className="bg-indigo-50 rounded-xl p-5 space-y-4">
                {/* Photo Upload */}
                <div className="flex flex-col items-center gap-3 p-4 bg-white rounded-lg border-2 border-dashed border-indigo-200">
                  {newHireForm.photo
                    ? <img src={newHireForm.photo} alt="Preview" className="w-28 h-28 rounded-full object-cover border-2 border-indigo-300" />
                    : <div className="w-28 h-28 rounded-full bg-indigo-100 flex items-center justify-center text-4xl border-2 border-dashed border-indigo-300">ğŸ‘¤</div>
                  }
                  <label className="cursor-pointer px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700 font-medium">
                    ğŸ“· {newHireForm.photo ? 'Change Photo' : 'Upload Photo'}
                    <input type="file" accept="image/*" onChange={handleNewHirePhoto} className="hidden" />
                  </label>
                  {newHireForm.photo && <button onClick={() => setNewHireForm(prev => ({...prev, photo: ''}))} className="text-xs text-red-500 hover:text-red-700">Remove photo</button>}
                </div>
                {/* Form Fields */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <input type="text" value={newHireForm.name} onChange={(e) => setNewHireForm({...newHireForm, name: e.target.value})} placeholder="Full Name *" className="px-3 py-2 border rounded-lg text-sm" />
                  <input type="text" value={newHireForm.position} onChange={(e) => setNewHireForm({...newHireForm, position: e.target.value})} placeholder="Position / Title" className="px-3 py-2 border rounded-lg text-sm" />
                  <input type="text" value={newHireForm.department} onChange={(e) => setNewHireForm({...newHireForm, department: e.target.value})} placeholder="Department" className="px-3 py-2 border rounded-lg text-sm" />
                  <div className="flex flex-col"><label className="text-xs text-gray-500 mb-1 ml-1">Start Date</label><input type="date" value={newHireForm.startDate} onChange={(e) => setNewHireForm({...newHireForm, startDate: e.target.value})} className="px-3 py-2 border rounded-lg text-sm" /></div>
                  <input type="tel" value={newHireForm.phone} onChange={(e) => setNewHireForm({...newHireForm, phone: e.target.value})} placeholder="Phone" className="px-3 py-2 border rounded-lg text-sm" />
                  <input type="email" value={newHireForm.email} onChange={(e) => setNewHireForm({...newHireForm, email: e.target.value})} placeholder="Email" className="px-3 py-2 border rounded-lg text-sm" />
                </div>
                <textarea value={newHireForm.notes} onChange={(e) => setNewHireForm({...newHireForm, notes: e.target.value})} placeholder="Notes (equipment needed, onboarding tasks, parking, uniform size, etc.)" className="w-full px-3 py-2 border rounded-lg text-sm min-h-24" />
                {!editingNewHireId && <button onClick={addNewHire} className="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">â• Add New Hire</button>}
              </div>
            </div>
          </div>
        )}

        {/* Contacts Tab */}
        {activeSection === 'contacts' && (
          <div className={`rounded-2xl shadow-2xl p-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
            <h2 className={`text-2xl font-serif font-bold mb-6 pb-4 border-b-2 ${darkMode ? 'text-white border-gray-600' : 'text-indigo-900 border-gray-200'}`}>ğŸ“‡ Contacts</h2>
            <div className="mb-4 flex gap-3 flex-wrap">
              <input type="text" placeholder="ğŸ” Search name, category, notes, phone..." value={contactSearch} onChange={(e) => setContactSearch(e.target.value)} className="flex-1 px-4 py-2 rounded-lg border min-w-48" />
            </div>
            <div className="mb-4 flex gap-2 flex-wrap">
              <button onClick={() => setContactCategoryFilter('all')} className={`px-3 py-1.5 rounded-lg text-xs font-medium ${contactCategoryFilter === 'all' ? 'bg-indigo-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>All ({contacts.length})</button>
              {contactCategories.sort().map(cat => { const count = contacts.filter(c => c.category === cat).length; if (count === 0) return null; return <button key={cat} onClick={() => setContactCategoryFilter(cat)} className={`px-3 py-1.5 rounded-lg text-xs font-medium ${contactCategoryFilter === cat ? 'bg-indigo-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>{cat} ({count})</button>; })}
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {getFilteredContacts().map(contact => (
                <div key={contact.id} className={`border rounded-xl p-4 hover:shadow-md transition-shadow ${editingContactId === contact.id ? 'bg-blue-50 border-blue-400 ring-2 ring-blue-300' : 'bg-white'}`}>
                  {editingContactId === contact.id ? (
                    <div className="space-y-3">
                      <div className="flex justify-between"><span className="font-bold text-blue-700">âœï¸ Editing Contact</span><button onClick={cancelEditContact} className="text-gray-500 hover:text-gray-700">âœ•</button></div>
                      <select value={contactForm.category} onChange={(e) => setContactForm({...contactForm, category: e.target.value})} className="w-full px-3 py-2 border rounded-lg text-sm">{contactCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}</select>
                      <input type="text" value={contactForm.name} onChange={(e) => setContactForm({...contactForm, name: e.target.value})} placeholder="Name *" className="w-full px-3 py-2 border rounded-lg text-sm" />
                      <input type="text" value={contactForm.phone} onChange={(e) => setContactForm({...contactForm, phone: e.target.value})} placeholder="Phone" className="w-full px-3 py-2 border rounded-lg text-sm" />
                      <input type="email" value={contactForm.email} onChange={(e) => setContactForm({...contactForm, email: e.target.value})} placeholder="Email" className="w-full px-3 py-2 border rounded-lg text-sm" />
                      <input type="text" value={contactForm.website} onChange={(e) => setContactForm({...contactForm, website: e.target.value})} placeholder="Website" className="w-full px-3 py-2 border rounded-lg text-sm" />
                      <textarea value={contactForm.notes} onChange={(e) => setContactForm({...contactForm, notes: e.target.value})} placeholder="Notes" className="w-full px-3 py-2 border rounded-lg text-sm min-h-16" />
                      <div className="flex gap-2"><button onClick={saveEditContact} className="flex-1 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">âœ“ Save</button><button onClick={cancelEditContact} className="flex-1 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancel</button></div>
                    </div>
                  ) : (
                    <>
                      <div className="flex justify-between items-start mb-2">
                        <span className="px-2 py-1 rounded text-xs font-semibold bg-indigo-100 text-indigo-800">{contact.category}</span>
                        <div className="flex gap-1">
                          <button onClick={() => startEditContact(contact)} className="w-7 h-7 bg-blue-100 hover:bg-blue-200 rounded flex items-center justify-center text-xs">âœï¸</button>
                          <button onClick={() => deleteContact(contact.id)} className="w-7 h-7 bg-gray-100 hover:bg-red-100 rounded flex items-center justify-center text-xs">Ã—</button>
                        </div>
                      </div>
                      <h3 className="font-bold text-gray-900 mt-2">{contact.name}</h3>
                      {contact.phone && <div className="mt-2 flex items-center gap-2"><span className="text-gray-500">ğŸ“</span><a href={`tel:${contact.phone.replace(/[^0-9+]/g, '').split('/')[0]}`} className="text-blue-600 hover:underline text-sm">{contact.phone}</a></div>}
                      {contact.email && <div className="mt-1 flex items-center gap-2"><span className="text-gray-500">âœ‰ï¸</span><a href={`mailto:${contact.email}`} className="text-blue-600 hover:underline text-sm break-all">{contact.email}</a></div>}
                      {contact.website && <div className="mt-1 flex items-center gap-2"><span className="text-gray-500">ğŸ”—</span><a href={contact.website.startsWith('http') ? contact.website : `https://${contact.website}`} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline text-sm break-all">{contact.website.replace(/https?:\/\//, '').substring(0, 30)}{contact.website.length > 40 ? '...' : ''}</a></div>}
                      {contact.notes && <div className="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600">ğŸ“ {contact.notes}</div>}
                    </>
                  )}
                </div>
              ))}
            </div>
            {getFilteredContacts().length === 0 && <div className="text-center py-12"><div className="text-5xl mb-4">ğŸ“‡</div><p className="text-gray-500">No contacts found</p></div>}
            <div className="mt-8 pt-6 border-t-2">
              <h3 className={`text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-indigo-900'}`}>â• Add New Contact</h3>
              <div className="bg-indigo-50 rounded-xl p-5 space-y-3">
                <div className="grid grid-cols-2 gap-3">
                  <select value={contactForm.category} onChange={(e) => setContactForm({...contactForm, category: e.target.value})} className="px-3 py-2 border rounded-lg text-sm">{contactCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}</select>
                  <input type="text" value={contactForm.name} onChange={(e) => setContactForm({...contactForm, name: e.target.value})} placeholder="Name *" className="px-3 py-2 border rounded-lg text-sm" />
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <input type="text" value={contactForm.phone} onChange={(e) => setContactForm({...contactForm, phone: e.target.value})} placeholder="Phone" className="px-3 py-2 border rounded-lg text-sm" />
                  <input type="email" value={contactForm.email} onChange={(e) => setContactForm({...contactForm, email: e.target.value})} placeholder="Email" className="px-3 py-2 border rounded-lg text-sm" />
                </div>
                <input type="text" value={contactForm.website} onChange={(e) => setContactForm({...contactForm, website: e.target.value})} placeholder="Website" className="w-full px-3 py-2 border rounded-lg text-sm" />
                <textarea value={contactForm.notes} onChange={(e) => setContactForm({...contactForm, notes: e.target.value})} placeholder="Notes" className="w-full px-3 py-2 border rounded-lg text-sm min-h-16" />
                {!editingContactId && <button onClick={addContact} className="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">â• Add Contact</button>}
              </div>
            </div>
            <div className="mt-8 pt-6 border-t-2">
              <h3 className={`text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-indigo-900'}`}>ğŸ” Account Information</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="border rounded-xl p-4 bg-blue-50"><h4 className="font-bold text-blue-900 mb-2">AT&T</h4><p className="text-xs text-gray-600">Account: 315703171</p><p className="text-xs text-gray-600">User: slridings91@gmail.com</p><p className="text-xs text-gray-600">Pass: Bethebestpart24!</p></div>
                <div className="border rounded-xl p-4 bg-purple-50"><h4 className="font-bold text-purple-900 mb-2">Spectrum</h4><p className="text-xs text-gray-600">Account: 124917101050125</p><p className="text-xs text-gray-600">Security: 264671</p><p className="text-xs text-gray-600">User: Jacob / Pass: Koch11@!</p></div>
                <div className="border rounded-xl p-4 bg-red-50"><h4 className="font-bold text-red-900 mb-2">Xfinity/Comcast</h4><p className="text-xs text-gray-600">Account: 8220 11 4.15 0157157</p><p className="text-xs text-gray-600">User: shelby@kosmiles.com</p><p className="text-xs text-gray-600">Pass: BeTheBestPart24!</p></div>
              </div>
            </div>
          </div>
        )}

        {/* Travel Tab */}
        {activeSection === 'travel' && (
          <div className={`rounded-2xl shadow-2xl p-6 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
            <h2 className={`text-2xl font-serif font-bold mb-6 pb-4 border-b-2 ${darkMode ? 'text-white border-gray-600' : 'text-indigo-900 border-gray-200'}`}>âœˆï¸ Travel</h2>
            {getUpcomingTravel().length > 0 && (
              <div className="mb-6 p-4 bg-cyan-50 border-l-4 border-cyan-500 rounded-r-lg">
                <h3 className="font-bold text-cyan-900 mb-2">ğŸ”” Upcoming</h3>
                {getUpcomingTravel().map(t => <div key={t.id} className="text-sm text-cyan-800"><strong>{t.description}</strong> â€” {t.daysUntil === 0 ? 'Today!' : t.daysUntil === 1 ? 'Tomorrow' : `${t.daysUntil} days`}</div>)}
              </div>
            )}
            <div className="mb-4 flex gap-3 flex-wrap">
              <input type="text" placeholder="ğŸ” Search..." value={travelSearchQuery} onChange={(e) => setTravelSearchQuery(e.target.value)} className="flex-1 px-4 py-2 rounded-lg border min-w-48" />
              {['all', ...travelTags].map(tag => <button key={tag} onClick={() => setTravelTagFilter(tag)} className={`px-3 py-2 rounded-lg text-sm ${travelTagFilter === tag ? 'bg-cyan-500 text-white' : 'bg-gray-100'}`}>{tag === 'all' ? 'All' : tag}</button>)}
            </div>
            <div className="overflow-x-auto mb-6">
              <table className="w-full">
                <thead><tr className="bg-blue-600 text-white"><th className="px-4 py-3 text-left text-sm">Type</th><th className="px-4 py-3 text-left text-sm">Description</th><th className="px-4 py-3 text-left text-sm">Start</th><th className="px-4 py-3 text-left text-sm">End</th><th className="px-4 py-3 text-left text-sm">Location</th><th className="px-4 py-3 text-left text-sm">Conf#</th><th className="px-4 py-3 text-sm">Actions</th></tr></thead>
                <tbody>
                  {(() => {
                    let filtered = travelEntries;
                    if (travelTagFilter !== 'all') filtered = filtered.filter(e => e.tags?.includes(travelTagFilter));
                    if (travelSearchQuery.trim()) { const q = travelSearchQuery.toLowerCase(); filtered = filtered.filter(e => (e.description||'').toLowerCase().includes(q) || (e.location||'').toLowerCase().includes(q)); }
                    if (!filtered.length) return <tr><td colSpan="7" className="py-12 text-center text-gray-500">No entries</td></tr>;
                    const icons = { 'Flight': 'âœˆï¸', 'Hotel': 'ğŸ¨', 'Car': 'ğŸš—', 'Event': 'ğŸ“…', 'Conference': 'ğŸ¤', 'Course': 'ğŸ“š' };
                    const colors = { 'Flight': 'bg-blue-100 text-blue-800', 'Hotel': 'bg-purple-100 text-purple-800', 'Car': 'bg-yellow-100 text-yellow-800', 'Event': 'bg-pink-100 text-pink-800', 'Conference': 'bg-green-100 text-green-800', 'Course': 'bg-green-100 text-green-800' };
                    return filtered.map(e => (
                      <tr key={e.id} className={`border-b hover:bg-gray-50 ${new Date(e.startDate) >= new Date() ? 'bg-yellow-50' : ''}`}>
                        <td className="px-4 py-3 text-sm"><span className={`px-2 py-1 rounded text-xs font-semibold ${colors[e.tags?.[0]] || 'bg-gray-100'}`}>{icons[e.tags?.[0]] || 'ğŸ“‹'} {e.tags?.[0] || e.type}</span></td>
                        <td className="px-4 py-3 text-sm">{e.description}</td>
                        <td className="px-4 py-3 text-sm">{e.startDate}</td>
                        <td className="px-4 py-3 text-sm">{e.endDate}</td>
                        <td className="px-4 py-3 text-sm">{e.location}</td>
                        <td className="px-4 py-3 text-sm font-mono">{e.confirmation}</td>
                        <td className="px-4 py-3 text-center"><button onClick={() => startEditTravel(e)} className="text-blue-600 mr-2">âœï¸</button><button onClick={() => deleteTravelEntry(e.id)} className="text-red-600">Ã—</button></td>
                      </tr>
                    ));
                  })()}
                </tbody>
              </table>
            </div>
            <div className="mt-8 pt-6 border-t-2">
              <h3 className={`text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-indigo-900'}`}>{editingTravelId ? 'âœï¸ Edit' : 'â• Add'} Travel</h3>
              <div className="bg-blue-50 rounded-xl p-5 space-y-3">
                <div className="flex flex-wrap gap-2">
                  {travelTags.map(tag => { const icons = { 'Flight': 'âœˆï¸', 'Hotel': 'ğŸ¨', 'Car': 'ğŸš—', 'Event': 'ğŸ“…', 'Conference': 'ğŸ¤', 'Course': 'ğŸ“š' }; return <button key={tag} onClick={() => setTravelForm({...travelForm, tags: travelForm.tags.includes(tag) ? travelForm.tags.filter(t => t !== tag) : [...travelForm.tags, tag]})} className={`px-3 py-1.5 rounded-lg text-sm font-semibold ${travelForm.tags.includes(tag) ? 'bg-cyan-500 text-white' : 'bg-gray-200'}`}>{icons[tag]} {tag}</button>; })}
                </div>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                  <input type="text" value={travelForm.description} onChange={(e) => setTravelForm({...travelForm, description: e.target.value})} placeholder="Description" className="px-3 py-2 border rounded-lg text-sm" />
                  <input type="date" value={travelForm.startDate} onChange={(e) => setTravelForm({...travelForm, startDate: e.target.value})} className="px-3 py-2 border rounded-lg text-sm" />
                  <input type="date" value={travelForm.endDate} onChange={(e) => setTravelForm({...travelForm, endDate: e.target.value})} className="px-3 py-2 border rounded-lg text-sm" />
                  <input type="text" value={travelForm.location} onChange={(e) => setTravelForm({...travelForm, location: e.target.value})} placeholder="Location" className="px-3 py-2 border rounded-lg text-sm" />
                  <input type="text" value={travelForm.confirmation} onChange={(e) => setTravelForm({...travelForm, confirmation: e.target.value})} placeholder="Confirmation #" className="px-3 py-2 border rounded-lg text-sm" />
                  <input type="url" value={travelForm.url} onChange={(e) => setTravelForm({...travelForm, url: e.target.value})} placeholder="URL (optional)" className="px-3 py-2 border rounded-lg text-sm" />
                </div>
                {editingTravelId ? (
                  <div className="flex gap-3"><button onClick={saveEditTravel} className="flex-1 py-2 bg-green-500 text-white rounded-lg">âœ“ Save</button><button onClick={cancelEditTravel} className="flex-1 py-2 bg-gray-400 text-white rounded-lg">Cancel</button></div>
                ) : (
                  <button onClick={addTravelEntry} className="w-full py-2 bg-blue-500 text-white rounded-lg">â• Add Entry</button>
                )}
              </div>
            </div>
            <div className="mt-8 pt-6 border-t-2"><Calendar year={calendarYear} /></div>
            <div className="mt-8 pt-6 border-t-2">
              <h3 className={`text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-indigo-900'}`}>ğŸ‡ºğŸ‡¸ 2026 Federal Holidays</h3>
              <div className="bg-red-50 rounded-xl p-5">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  {federalHolidays.map((h, i) => (
                    <div key={i} className="flex justify-between items-center p-2 bg-white rounded-lg border border-red-200">
                      <span className="font-medium text-gray-800">{h.name}</span>
                      <span className="text-sm text-red-600 font-mono">{new Date(h.date + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

const App = () => <PasswordGate>{(handleLogout) => <DailyTaskTracker onLogout={handleLogout} />}</PasswordGate>;
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
HTMLEOF
echo "done"
